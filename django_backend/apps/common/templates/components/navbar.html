{% load static %}
<nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
    <div class="container-fluid">
        <!-- Brand -->
        <a class="navbar-brand d-flex align-items-center" href="{% url 'common:dashboard' %}">
            <img src="{% static 'images/logo.png' %}" alt="TMS" width="32" height="32" class="me-2">
            <span class="fw-bold">TaskMS</span>
        </a>

        <!-- Mobile toggle button -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Navigation items -->
        <div class="collapse navbar-collapse" id="navbarNav">
            {% if user.is_authenticated %}
                <!-- Main navigation -->
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" 
                           href="{% url 'common:dashboard' %}">
                            <i class="bi bi-house-fill me-1"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'tasks' in request.resolver_match.app_names %}active{% endif %}" 
                           href="{% url 'tasks:task_list' %}">
                            <i class="bi bi-list-task me-1"></i>
                            Tasks
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="projectsDropdown" role="button" 
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-folder-fill me-1"></i>
                            Projects
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="projectsDropdown">
                            <li><a class="dropdown-item" href="#">All Projects</a></li>
                            <li><a class="dropdown-item" href="#">My Projects</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#">Create Project</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'teams' in request.resolver_match.app_names %}active{% endif %}" 
                           href="#">
                            <i class="bi bi-people-fill me-1"></i>
                            Teams
                        </a>
                    </li>
                    {% if user.is_staff %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" 
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-gear-fill me-1"></i>
                                Admin
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="adminDropdown">
                                <li><a class="dropdown-item" href="{% url 'admin:index' %}">
                                    <i class="bi bi-shield-check me-1"></i>Admin Panel
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'common:system_status' %}">
                                    <i class="bi bi-activity me-1"></i>System Status
                                </a></li>
                                <li><a class="dropdown-item" href="#">
                                    <i class="bi bi-bar-chart-fill me-1"></i>Analytics
                                </a></li>
                            </ul>
                        </li>
                    {% endif %}
                </ul>

                <!-- Search bar -->
                <form class="d-flex me-3" method="get" action="{% url 'common:global_search' %}">
                    <div class="input-group">
                        <input class="form-control form-control-sm" type="search" name="q" 
                               placeholder="Search tasks, projects..." aria-label="Search"
                               value="{{ request.GET.q }}">
                        <button class="btn btn-outline-light btn-sm" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </form>

                <!-- Right side navigation -->
                <ul class="navbar-nav">
                    <!-- Notifications -->
                    <li class="nav-item dropdown">
                        <a class="nav-link position-relative" href="#" id="notificationsDropdown" role="button" 
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-bell-fill"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" 
                                  id="notification-count" style="display: none;">
                                0
                            </span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationsDropdown">
                            <li class="dropdown-header d-flex justify-content-between align-items-center">
                                <span>Notifications</span>
                                <a href="{% url 'common:mark_notifications_read' %}" class="btn btn-sm btn-link p-0">
                                    Mark all read
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li id="notifications-list">
                                <div class="dropdown-item-text text-muted text-center py-3">
                                    No new notifications
                                </div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-center" href="{% url 'common:notification_list' %}">
                                    View all notifications
                                </a>
                            </li>
                        </ul>
                    </li>

                    <!-- Theme toggle -->
                    <li class="nav-item">
                        <button class="nav-link btn btn-link border-0 text-light" id="theme-toggle" type="button">
                            <i class="bi bi-moon-fill"></i>
                        </button>
                    </li>

                    <!-- User dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" 
                           role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            {% if user.profile.avatar %}
                                <img src="{{ user.profile.avatar.url }}" alt="Avatar" 
                                     class="rounded-circle me-2" width="24" height="24">
                            {% else %}
                                <i class="bi bi-person-circle me-2"></i>
                            {% endif %}
                            {{ user.get_full_name|default:user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li class="dropdown-header">
                                <small class="text-muted">{{ user.email }}</small>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="{% url 'users:profile' user.pk %}">
                                    <i class="bi bi-person me-1"></i>Profile
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'common:user_settings' %}">
                                    <i class="bi bi-gear me-1"></i>Settings
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#">
                                    <i class="bi bi-question-circle me-1"></i>Help
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form method="post" action="{% url 'authentication:logout' %}" class="m-0">
                                    {% csrf_token %}
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="bi bi-box-arrow-right me-1"></i>Logout
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </li>
                </ul>
            {% else %}
                <!-- Unauthenticated user navigation -->
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'authentication:login' %}">
                            <i class="bi bi-box-arrow-in-right me-1"></i>Login
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'authentication:register' %}">
                            <i class="bi bi-person-plus me-1"></i>Register
                        </a>
                    </li>
                </ul>
            {% endif %}
        </div>
    </div>
</nav>

<!-- Initialize theme toggle icon -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const icon = themeToggle.querySelector('i');
            if (currentTheme === 'dark') {
                icon.className = 'bi bi-sun-fill';
            } else {
                icon.className = 'bi bi-moon-fill';
            }
        }

        // Load notification count
        fetch('{% url "common:unread_notification_count" %}')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('notification-count');
                if (data.count > 0) {
                    badge.textContent = data.count > 99 ? '99+' : data.count;
                    badge.style.display = 'block';
                }
            })
            .catch(error => console.log('Notification count error:', error));
    });
</script>

<style>
.notification-dropdown {
    width: 320px;
    max-height: 400px;
    overflow-y: auto;
}

.navbar-nav .nav-link.active {
    font-weight: 600;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 0.375rem;
}

@media (max-width: 991.98px) {
    .notification-dropdown {
        width: 280px;
    }
}
</style>
